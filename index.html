<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark Vocab - Ultimate Edition</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-select { -webkit-user-select: none; user-select: none; }
        .card-inner { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        ::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; overflow-x: hidden; }
        .hidden-verb { filter: blur(10px); background: rgba(255,255,255,0.15); border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // Marker für den HTML-Daten-Export
        window.__SPARK_INJECTED_DATA__ = null;

        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Book: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
            Shuffle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Folder: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>,
            ArrowLeft: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
            Activity: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
            Eye: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        };

        const App = () => {
            // --- STATE ---
            const [categories, setCategories] = useState([]);
            const [cards, setCards] = useState([]);
            const [activeTab, setActiveTab] = useState('home');
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [studySession, setStudySession] = useState(null);
            const [revealedForms, setRevealedForms] = useState({});

            // Modals
            const [showSettings, setShowSettings] = useState(false);
            const [showNewCat, setShowNewCat] = useState(false);
            const [showRandomChoice, setShowRandomChoice] = useState(false);
            
            // Edit-States
            const [catInput, setCatInput] = useState('');
            const [editingCatId, setEditingCatId] = useState(null);
            
            const [cardInput, setCardInput] = useState({ id: null, front: '', back: '', type: 'standard', verbForms: { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } });

            const fileInputRef = useRef(null);

            // --- PERSISTENCE ---
            useEffect(() => {
                const storageKey = 'spark_v15_data';
                let initialData = { categories: [], cards: [] };

                if (window.__SPARK_INJECTED_DATA__) {
                    initialData = window.__SPARK_INJECTED_DATA__;
                } else {
                    const saved = localStorage.getItem(storageKey);
                    if (saved) {
                        try { initialData = JSON.parse(saved); } catch (e) { console.error("Parse Error", e); }
                    }
                }
                setCategories(initialData.categories || []);
                setCards(initialData.cards || []);
            }, []);

            useEffect(() => {
                localStorage.setItem('spark_v15_data', JSON.stringify({ categories, cards }));
            }, [categories, cards]);

            // --- EXPORT/IMPORT ---
            const handleExport = () => {
                const dataString = JSON.stringify({ categories, cards });
                const currentHtml = document.documentElement.outerHTML;
                const marker = 'window.__SPARK_INJECTED_DATA__ = null;';
                const replacement = `window.__SPARK_INJECTED_DATA__ = ${dataString};`;
                const newHtml = currentHtml.replace(marker, replacement);
                
                const blob = new Blob([newHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `SparkVocab_Library.html`;
                a.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    const match = content.match(/window\.__SPARK_INJECTED_DATA__ = (\{.*?\});/);
                    if (match && match[1]) {
                        try {
                            const data = JSON.parse(match[1]);
                            if (confirm("Daten aus Datei laden? Aktuelle Daten gehen verloren.")) {
                                setCategories(data.categories || []);
                                setCards(data.cards || []);
                                setShowSettings(false);
                            }
                        } catch (err) { alert("Datei korrupt."); }
                    } else { alert("Keine Spark-Daten gefunden."); }
                };
                reader.readAsText(file);
            };

            // --- CRUD ACTIONS ---
            const saveCategory = () => {
                if (!catInput.trim()) return;
                if (editingCatId) {
                    setCategories(prev => prev.map(c => c.id === editingCatId ? { ...c, name: catInput.trim() } : c));
                } else {
                    setCategories(prev => [...prev, { id: Date.now(), name: catInput.trim() }]);
                }
                setCatInput(''); setEditingCatId(null); setShowNewCat(false);
            };

            const deleteCategory = (id) => {
                if (confirm("Ordner und alle Inhalte löschen?")) {
                    setCategories(prev => prev.filter(c => c.id !== id));
                    setCards(prev => prev.filter(c => c.categoryId !== id));
                }
            };

            const saveCard = (e) => {
                e.preventDefault();
                if (!cardInput.front || !cardInput.back) return;
                if (cardInput.id) {
                    setCards(prev => prev.map(c => c.id === cardInput.id ? { ...c, front: cardInput.front, back: cardInput.back, type: cardInput.type, verbForms: cardInput.type === 'verb' ? cardInput.verbForms : null } : c));
                } else {
                    const newCard = { 
                        id: Date.now(), 
                        categoryId: selectedCategory.id, 
                        type: cardInput.type, 
                        front: cardInput.front, 
                        back: cardInput.back, 
                        verbForms: cardInput.type === 'verb' ? cardInput.verbForms : null,
                        srs: { interval: 0, ease: 2.5, repetitions: 0, nextReview: Date.now() }
                    };
                    setCards(prev => [newCard, ...prev]);
                }
                setCardInput({ id: null, front: '', back: '', type: 'standard', verbForms: { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } });
            };

            // --- LEARNING LOGIC ---
            const startSRS = (cat) => {
                const now = Date.now();
                const due = cards.filter(c => c.categoryId === cat.id && c.srs.nextReview <= now);
                if (due.length === 0) return alert("Alles gelernt! Nutze den Zufallsmodus zum Üben.");
                setStudySession({ queue: due.sort(() => Math.random() - 0.5), index: 0, flipped: false, title: cat.name, isRandom: false, isChanging: false });
                setRevealedForms({});
            };

            const startRandom = (catId = null) => {
                let filtered = cards.filter(c => c.type === 'standard');
                if (catId) filtered = filtered.filter(c => c.categoryId === catId);
                if (filtered.length === 0) return alert("Keine Vokabeln vorhanden.");
                const queue = filtered.map(c => {
                    const flip = Math.random() > 0.5;
                    return { ...c, displayFront: flip ? c.back : c.front, displayBack: flip ? c.front : c.back };
                }).sort(() => Math.random() - 0.5);
                setStudySession({ queue, index: 0, flipped: false, title: catId ? "Zufall (Ordner)" : "Zufall (Alle)", isRandom: true, isChanging: false });
                setShowRandomChoice(false);
            };

            const startVerbs = () => {
                const verbCards = cards.filter(c => c.type === 'verb');
                if (verbCards.length === 0) return alert("Keine Verben vorhanden.");
                setStudySession({ queue: verbCards.sort(() => Math.random() - 0.5), index: 0, flipped: false, title: "Verben Training", isRandom: true, isChanging: false });
            };

            const handleRate = (rating) => {
                if (studySession.isChanging) return;
                if (!studySession.isRandom) {
                    const cardId = studySession.queue[studySession.index].id;
                    setCards(prev => prev.map(c => {
                        if (c.id !== cardId) return c;
                        let { interval, ease, repetitions } = c.srs;
                        if (rating === 0) { repetitions = 0; interval = 1; ease = Math.max(1.3, ease - 0.2); }
                        else if (rating === 1) { interval = repetitions === 0 ? 1 : Math.round(interval * 1.5); repetitions += 1; }
                        else { if (repetitions === 0) interval = 1; else if (repetitions === 1) interval = 4; else interval = Math.round(interval * ease); repetitions += 1; ease += 0.1; }
                        return { ...c, srs: { interval, ease, repetitions, nextReview: Date.now() + (interval * 24 * 60 * 60 * 1000) } };
                    }));
                }
                setStudySession(prev => ({ ...prev, flipped: false, isChanging: true }));
                setTimeout(() => {
                    if (studySession.index + 1 < studySession.queue.length) {
                        setStudySession(prev => ({ ...prev, index: prev.index + 1, isChanging: false }));
                        setRevealedForms({});
                    } else { setStudySession(null); }
                }, 400);
            };

            const getDueCount = (id) => cards.filter(c => c.categoryId === id && c.srs.nextReview <= Date.now()).length;

            // --- RENDER ---
            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col shadow-2xl relative overflow-hidden">
                    <input type="file" ref={fileInputRef} onChange={handleImport} accept=".html" className="hidden" />

                    {/* HEADER */}
                    <header className="p-4 border-b bg-white flex items-center justify-between sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-3">
                            {activeTab !== 'home' && (
                                <button onClick={() => { setActiveTab('home'); setSelectedCategory(null); }} className="p-2 -ml-2 text-slate-400 hover:bg-slate-50 rounded-full"><Icons.ArrowLeft /></button>
                            )}
                            <h1 className="font-extrabold text-xl text-slate-800">{activeTab === 'home' ? 'Spark Vocab' : (selectedCategory?.name || 'Vorschau')}</h1>
                        </div>
                        {activeTab === 'home' && <button onClick={() => setShowSettings(true)} className="p-2 text-slate-300 hover:text-indigo-600 transition-colors"><Icons.Settings /></button>}
                    </header>

                    <main className="flex-1 p-5 overflow-y-auto pb-20">
                        {/* HOME TAB */}
                        {activeTab === 'home' && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowRandomChoice(true)} className="bg-indigo-600 text-white p-4 rounded-3xl shadow-lg flex flex-col items-center justify-center gap-2 active:scale-95 transition-all"><Icons.Shuffle /><span className="text-[10px] font-black uppercase">Zufall (Vok)</span></button>
                                    <button onClick={startVerbs} className="bg-emerald-600 text-white p-4 rounded-3xl shadow-lg flex flex-col items-center justify-center gap-2 active:scale-95 transition-all text-center leading-tight"><Icons.Activity /><span className="text-[10px] font-black uppercase">Verben (RO)</span></button>
                                </div>
                                <div className="flex justify-between items-center px-1 pt-4">
                                    <h2 className="text-sm font-black uppercase tracking-widest text-slate-400">Deine Ordner</h2>
                                    <button onClick={() => { setEditingCatId(null); setCatInput(''); setShowNewCat(true); }} className="text-indigo-600 font-bold flex items-center gap-1 text-sm"><Icons.Plus /> Neu</button>
                                </div>
                                <div className="grid gap-3">
                                    {categories.map(cat => (
                                        <div key={cat.id} className="group relative bg-white rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-all active:bg-slate-100">
                                            <div onClick={() => { setSelectedCategory(cat); setActiveTab('detail'); }} className="p-5 flex items-center justify-between cursor-pointer">
                                                <div className="flex items-center gap-4">
                                                    <div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><Icons.Folder /></div>
                                                    <div className="font-bold text-slate-800 truncate max-w-[140px]">{cat.name}</div>
                                                </div>
                                                {getDueCount(cat.id) > 0 && <span className="bg-orange-500 text-white text-[10px] px-2 py-1 rounded-full font-black">{getDueCount(cat.id)}</span>}
                                            </div>
                                            <div className="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={(e) => { e.stopPropagation(); setEditingCatId(cat.id); setCatInput(cat.name); setShowNewCat(true); }} className="p-2 text-indigo-400 hover:bg-indigo-50 rounded-lg"><Icons.Edit /></button>
                                                <button onClick={(e) => { e.stopPropagation(); deleteCategory(cat.id); }} className="p-2 text-rose-300 hover:text-rose-500 rounded-lg"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* DETAIL TAB */}
                        {activeTab === 'detail' && selectedCategory && (
                            <div className="space-y-6 animate-in slide-in-from-right-4 pb-20">
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => startSRS(selectedCategory)} className={`py-4 rounded-3xl font-black text-xs shadow-lg flex items-center justify-center gap-2 ${getDueCount(selectedCategory.id) > 0 ? 'bg-indigo-600 text-white shadow-indigo-100' : 'bg-slate-200 text-slate-400'}`}><Icons.Book /> {getDueCount(selectedCategory.id)} fällig</button>
                                    <button onClick={() => startRandom(selectedCategory.id)} className="bg-slate-800 text-white py-4 rounded-3xl font-black text-xs shadow-lg flex items-center justify-center gap-2 active:scale-95"><Icons.Shuffle /> Zufall</button>
                                </div>

                                <form onSubmit={saveCard} className="bg-white border-2 border-indigo-100 p-5 rounded-3xl space-y-4 shadow-sm">
                                    <div className="flex bg-slate-100 p-1 rounded-xl">
                                        <button type="button" onClick={() => setCardInput({...cardInput, type: 'standard'})} className={`flex-1 py-2 text-[10px] font-black rounded-lg ${cardInput.type === 'standard' ? 'bg-white shadow-sm' : 'text-slate-400'}`}>VOKABEL</button>
                                        <button type="button" onClick={() => setCardInput({...cardInput, type: 'verb'})} className={`flex-1 py-2 text-[10px] font-black rounded-lg ${cardInput.type === 'verb' ? 'bg-white shadow-sm' : 'text-slate-400'}`}>VERB (RO)</button>
                                    </div>
                                    <div className="space-y-3">
                                        <input className="w-full p-4 rounded-2xl bg-slate-50 outline-none border focus:border-indigo-500" placeholder={cardInput.type === 'verb' ? "Infinitiv" : "Frage"} value={cardInput.front} onChange={e => setCardInput({...cardInput, front: e.target.value})} />
                                        <input className="w-full p-4 rounded-2xl bg-slate-50 outline-none border focus:border-indigo-500" placeholder="Antwort" value={cardInput.back} onChange={e => setCardInput({...cardInput, back: e.target.value})} />
                                        {cardInput.type === 'verb' && (
                                            <div className="grid grid-cols-2 gap-2">
                                                {['eu', 'tu', 'elEa', 'noi', 'voi', 'eiEle'].map(p => (
                                                    <input key={p} className="p-3 text-xs rounded-xl bg-slate-50 outline-none border focus:border-indigo-500" placeholder={p === 'elEa' ? 'el/ea' : p === 'eiEle' ? 'ei/ele' : p} value={cardInput.verbForms[p]} onChange={e => setCardInput({...cardInput, verbForms: {...cardInput.verbForms, [p]: e.target.value}})} />
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex gap-2">
                                        <button type="submit" className="flex-[3] bg-slate-800 text-white py-4 rounded-2xl font-bold">{cardInput.id ? 'Update' : 'Hinzufügen'}</button>
                                        {cardInput.id && <button type="button" onClick={() => setCardInput({ id: null, front: '', back: '', type: 'standard', verbForms: { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } })} className="flex-1 bg-slate-200 text-slate-500 py-4 rounded-2xl font-bold">X</button>}
                                    </div>
                                </form>

                                <div className="space-y-2">
                                    {cards.filter(c => c.categoryId === selectedCategory.id).map(card => (
                                        <div key={card.id} className="p-4 bg-white border rounded-2xl flex justify-between items-center group shadow-sm transition-all hover:border-indigo-200">
                                            <div className="truncate pr-4 leading-tight">
                                                <div className="font-bold text-slate-800 truncate">{card.front} {card.type === 'verb' && <span className="text-[7px] bg-emerald-100 text-emerald-600 px-1 rounded font-black uppercase ml-1">Verb</span>}</div>
                                                <div className="text-xs text-slate-400 truncate">{card.back}</div>
                                            </div>
                                            <div className="flex items-center gap-1 opacity-20 group-hover:opacity-100 shrink-0">
                                                <button onClick={() => { setCardInput({ ...card, verbForms: card.verbForms || { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } }); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="text-indigo-500 p-2"><Icons.Edit /></button>
                                                <button onClick={() => setCards(prev => prev.filter(c => c.id !== card.id))} className="text-rose-500 p-2"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* STUDY OVERLAY */}
                        {studySession && (
                            <div className="fixed inset-0 bg-slate-50 z-[100] flex flex-col p-6 animate-in fade-in no-select">
                                <div className="flex justify-between items-center mb-6">
                                    <button onClick={() => setStudySession(null)} className="text-slate-400 font-bold text-sm">Beenden</button>
                                    <div className="text-center"><div className="text-[9px] font-black uppercase text-slate-400 tracking-widest">{studySession.title}</div><div className="text-xs font-bold text-slate-800">{studySession.index + 1} / {studySession.queue.length}</div></div>
                                    <div className="w-10"></div>
                                </div>
                                <div className="flex-1 flex items-center justify-center perspective-1000">
                                    <div className={`relative w-full aspect-[4/5] max-h-[520px] card-inner preserve-3d cursor-pointer ${studySession.flipped ? 'rotate-y-180' : ''}`} onClick={() => !studySession.isChanging && setStudySession({...studySession, flipped: !studySession.flipped})}>
                                        <div className="absolute inset-0 backface-hidden bg-white rounded-[2.5rem] shadow-2xl border flex flex-col items-center justify-center p-10 text-center">
                                            <div className="text-3xl font-black text-slate-800 leading-tight">{studySession.isRandom ? studySession.queue[studySession.index].displayFront : studySession.queue[studySession.index].front}</div>
                                            <div className="absolute bottom-10 text-indigo-300 uppercase tracking-widest text-[9px] font-black animate-pulse">Tippen zum Umdrehen</div>
                                        </div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-indigo-600 rounded-[2.5rem] shadow-2xl flex flex-col items-center justify-center p-6 text-center text-white overflow-hidden">
                                            {studySession.flipped && (
                                                <div className="w-full">
                                                    {studySession.queue[studySession.index].type === 'verb' ? (
                                                        <div className="space-y-4 w-full">
                                                            <div className="mb-2"><div className="text-2xl font-black mb-1">{studySession.queue[studySession.index].back}</div><div className="text-indigo-200 text-xs font-bold uppercase tracking-widest">{studySession.queue[studySession.index].front}</div></div>
                                                            <div className="bg-indigo-500/40 p-4 rounded-3xl border border-indigo-400/30 space-y-1">
                                                                {[
                                                                    {l:'eu',k:'eu'},{l:'tu',k:'tu'},{l:'el/ea',k:'elEa'},{l:'noi',k:'noi'},{l:'voi',k:'voi'},{l:'ei/ele',k:'eiEle'}
                                                                ].map((item, idx) => (
                                                                    <div key={idx} onClick={(e) => { e.stopPropagation(); setRevealedForms(prev => ({ ...prev, [idx]: !prev[idx] })); }} className={`flex justify-between items-center py-1.5 px-3 rounded-xl transition-colors cursor-pointer ${revealedForms[idx] ? 'bg-indigo-400/20' : 'hover:bg-white/5'}`}>
                                                                        <span className="text-[10px] text-indigo-200 uppercase font-black tracking-wider">{item.l}</span>
                                                                        <div className="flex items-center gap-2"><span className={`font-bold transition-all duration-300 ${revealedForms[idx] ? 'opacity-100' : 'opacity-0 hidden-verb text-transparent select-none'}`}>{studySession.queue[studySession.index].verbForms[item.k]}</span>{!revealedForms[idx] && <Icons.Eye />}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="text-3xl font-black leading-tight">{studySession.isRandom ? studySession.queue[studySession.index].displayBack : studySession.queue[studySession.index].back}</div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className={`mt-10 grid gap-3 transition-all duration-300 ${studySession.flipped && !studySession.isChanging ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                                    {studySession.isRandom ? (
                                        <button onClick={() => handleRate(1)} className="bg-slate-800 text-white py-5 rounded-3xl font-black text-lg shadow-xl active:scale-95">Nächste Karte</button>
                                    ) : (
                                        <div className="grid grid-cols-3 gap-3">
                                            <button onClick={() => handleRate(0)} className="bg-rose-500 text-white py-5 rounded-3xl flex flex-col items-center gap-1 active:scale-90 shadow-lg"><Icons.Shuffle /><span className="text-[10px] font-black uppercase">Nicht</span></button>
                                            <button onClick={() => handleRate(1)} className="bg-amber-500 text-white py-5 rounded-3xl flex flex-col items-center gap-1 active:scale-90 shadow-lg"><Icons.Book /><span className="text-[10px] font-black uppercase">Mittel</span></button>
                                            <button onClick={() => handleRate(2)} className="bg-emerald-500 text-white py-5 rounded-3xl flex flex-col items-center gap-1 active:scale-90 shadow-lg"><Icons.Plus /><span className="text-[10px] font-black uppercase">Gut</span></button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* SETTINGS MODAL */}
                        {showSettings && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-center justify-center p-6" onClick={() => setShowSettings(false)}>
                                <div className="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl space-y-6" onClick={e => e.stopPropagation()}>
                                    <h2 className="text-xl font-black text-slate-800">Sicherung</h2>
                                    <div className="space-y-4">
                                        <button onClick={handleExport} className="w-full flex items-center justify-between p-5 bg-indigo-50 text-indigo-700 rounded-2xl font-bold active:bg-indigo-100 transition-colors">App mit Daten exportieren <Icons.Download /></button>
                                        <button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-between p-5 bg-emerald-50 text-emerald-700 rounded-2xl font-bold active:bg-emerald-100 transition-colors">Daten importieren <Icons.Plus /></button>
                                    </div>
                                    <button onClick={() => setShowSettings(false)} className="w-full text-slate-400 py-2 text-sm font-bold">Schließen</button>
                                </div>
                            </div>
                        )}

                        {/* RANDOM CHOICE MODAL */}
                        {showRandomChoice && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-end sm:items-center justify-center p-4" onClick={() => setShowRandomChoice(false)}>
                                <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl space-y-4" onClick={e => e.stopPropagation()}>
                                    <h2 className="text-lg font-black text-slate-800 text-center">Zufallstraining</h2>
                                    <button onClick={() => startRandom()} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black transition-transform active:scale-95">Alle Ordner mischen</button>
                                    <div className="max-h-60 overflow-y-auto space-y-2">
                                        <p className="text-[9px] font-black uppercase text-slate-400 tracking-widest px-1">Ordner wählen</p>
                                        {categories.map(cat => (
                                            <button key={cat.id} onClick={() => startRandom(cat.id)} className="w-full bg-slate-100 text-slate-700 py-3 px-4 rounded-xl text-left font-bold text-sm truncate">{cat.name}</button>
                                        ))}
                                    </div>
                                    <button onClick={() => setShowRandomChoice(false)} className="w-full text-slate-400 py-2 text-sm font-bold">Abbrechen</button>
                                </div>
                            </div>
                        )}

                        {/* NEW CAT MODAL */}
                        {showNewCat && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-center justify-center p-6" onClick={() => setShowNewCat(false)}>
                                <div className="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl space-y-6" onClick={e => e.stopPropagation()}>
                                    <h2 className="text-xl font-black text-slate-800">{editingCatId ? 'Ordner umbenennen' : 'Neuer Ordner'}</h2>
                                    <input autoFocus className="w-full p-4 rounded-2xl bg-slate-100 outline-none focus:ring-2 focus:ring-indigo-500 font-bold" placeholder="Name..." value={catInput} onChange={e => setCatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && saveCategory()} />
                                    <div className="flex gap-3">
                                        <button onClick={saveCategory} className="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold transition-transform active:scale-95">{editingCatId ? 'Update' : 'Erstellen'}</button>
                                        <button onClick={() => setShowNewCat(false)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold">X</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // --- Initialisierung ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

