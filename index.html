<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark Vocab - Multi-Language Pro</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-select { -webkit-user-select: none; user-select: none; }
        .card-inner { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        ::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; overflow-x: hidden; }
        .hidden-verb { filter: blur(10px); background: rgba(255,255,255,0.15); border-radius: 4px; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(22, 1fr); gap: 3px; }
        .heatmap-cell { aspect-ratio: 1/1; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // Marker für den HTML-Daten-Export
        window.__SPARK_DATA__ = null;

        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Book: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
            Shuffle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Folder: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>,
            ArrowLeft: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
            Activity: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
            Info: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            Eye: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Globe: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>,
            BarChart: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>,
            Flame: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.5 3.5 6.5 1 1.5 2 2.722 2 4.5a6 6 0 1 1-12 0c0-1.5 1-3 2-4.5.5 1.5 1.5 3 2 4.5z"></path></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        };

        const App = () => {
            // --- DATEN-STATE ---
            const [languages, setLanguages] = useState([]);
            const [categories, setCategories] = useState([]);
            const [cards, setCards] = useState([]);
            const [history, setHistory] = useState([]);

            // --- NAVIGATION-STATE ---
            const [view, setView] = useState('LANGUAGES'); // 'LANGUAGES', 'HOME', 'DETAIL'
            const [selectedLangId, setSelectedLangId] = useState(null);
            const [selectedCatId, setSelectedCatId] = useState(null);

            // --- UI-MODALS-STATE ---
            const [showSettings, setShowSettings] = useState(false);
            const [showNewModal, setShowNewModal] = useState({ type: null, id: null }); // 'lang', 'cat'
            const [showRandomChoice, setShowRandomChoice] = useState(false);
            const [showStats, setShowStats] = useState(false);
            const [analysisCard, setAnalysisCard] = useState(null);
            const [studySession, setStudySession] = useState(null);
            const [revealedForms, setRevealedForms] = useState({});

            // --- INPUT-STATE ---
            const [modalInput, setModalInput] = useState('');
            const [cardInput, setCardInput] = useState({ id: null, front: '', back: '', type: 'standard', verbForms: { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } });

            const fileInputRef = useRef(null);

            // --- INITIALISIERUNG ---
            useEffect(() => {
                const storageKey = 'spark_multilang_pro_v22';
                let data = { languages: [], categories: [], cards: [], history: [] };

                if (window.__SPARK_DATA__) {
                    data = window.__SPARK_DATA__;
                } else {
                    const saved = localStorage.getItem(storageKey);
                    if (saved) { try { data = JSON.parse(saved); } catch(e){} }
                }
                setLanguages(data.languages || []);
                setCategories(data.categories || []);
                setCards((data.cards || []).map(c => ({ ...c, totalAttempts: c.totalAttempts || 0 })));
                setHistory(data.history || []);
            }, []);

            useEffect(() => {
                localStorage.setItem('spark_multilang_pro_v22', JSON.stringify({ languages, categories, cards, history }));
            }, [languages, categories, cards, history]);

            // --- COMPUTED VALUES ---
            const activeLang = useMemo(() => languages.find(l => l.id === selectedLangId), [languages, selectedLangId]);
            const langCategories = useMemo(() => categories.filter(c => c.languageId === selectedLangId), [categories, selectedLangId]);
            const activeCategory = useMemo(() => categories.find(c => c.id === selectedCatId), [categories, selectedCatId]);
            const folderCards = useMemo(() => cards.filter(c => c.categoryId === selectedCatId), [cards, selectedCatId]);

            // --- SRS LOGIK ---
            const calcNextSRS = (card, rating) => {
                let { interval, ease, repetitions } = card.srs;
                if (rating === 0) { repetitions = 0; interval = 1; ease = Math.max(1.3, ease - 0.2); }
                else if (rating === 1) { interval = repetitions === 0 ? 1 : Math.round(interval * 1.5); repetitions += 1; }
                else { 
                    if (repetitions === 0) interval = 1; else if (repetitions === 1) interval = 4; else interval = Math.round(interval * ease);
                    repetitions += 1; ease += 0.1;
                }
                return { interval, ease, repetitions, nextReview: Date.now() + (interval * 24 * 60 * 60 * 1000) };
            };

            // --- HANDLER ---
            const saveLanguage = () => {
                if (!modalInput.trim()) return;
                if (showNewModal.id) {
                    setLanguages(prev => prev.map(l => l.id === showNewModal.id ? { ...l, name: modalInput.trim() } : l));
                } else {
                    setLanguages(prev => [...prev, { id: Date.now(), name: modalInput.trim() }]);
                }
                setModalInput(''); setShowNewModal({ type: null, id: null });
            };

            const saveCategory = () => {
                if (!modalInput.trim() || !selectedLangId) return;
                if (showNewModal.id) {
                    setCategories(prev => prev.map(c => c.id === showNewModal.id ? { ...c, name: modalInput.trim() } : c));
                } else {
                    setCategories(prev => [...prev, { id: Date.now(), name: modalInput.trim(), languageId: selectedLangId }]);
                }
                setModalInput(''); setShowNewModal({ type: null, id: null });
            };

            const saveCard = (e) => {
                e.preventDefault();
                if (!cardInput.front || !cardInput.back || !selectedCatId) return;
                if (cardInput.id) {
                    setCards(prev => prev.map(c => c.id === cardInput.id ? { ...c, front: cardInput.front, back: cardInput.back, type: cardInput.type, verbForms: cardInput.type === 'verb' ? cardInput.verbForms : null } : c));
                } else {
                    const newCard = { 
                        id: Date.now(), 
                        languageId: selectedLangId,
                        categoryId: selectedCatId, 
                        type: cardInput.type, 
                        front: cardInput.front, 
                        back: cardInput.back, 
                        verbForms: cardInput.type === 'verb' ? cardInput.verbForms : null,
                        srs: { interval: 0, ease: 2.5, repetitions: 0, nextReview: Date.now() },
                        totalAttempts: 0
                    };
                    setCards(prev => [newCard, ...prev]);
                }
                setCardInput({ id: null, front: '', back: '', type: 'standard', verbForms: { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } });
            };

            const handleRate = (rating) => {
                if (!studySession || studySession.isChanging) return;
                const cardId = studySession.queue[studySession.index].id;
                const today = new Date().toISOString().split('T')[0];

                setHistory(prev => [...prev, { date: today, languageId: selectedLangId, rating, timestamp: Date.now() }]);
                setCards(prev => prev.map(c => {
                    if (c.id === cardId) {
                        const newSRS = studySession.isRandom ? c.srs : calcNextSRS(c, rating);
                        return { ...c, srs: newSRS, totalAttempts: (c.totalAttempts || 0) + 1 };
                    }
                    return c;
                }));

                setStudySession(prev => ({ ...prev, flipped: false, isChanging: true }));
                setTimeout(() => {
                    if (studySession.index + 1 < studySession.queue.length) {
                        setStudySession(prev => ({ ...prev, index: prev.index + 1, isChanging: false }));
                        setRevealedForms({});
                    } else { setStudySession(null); setShowStats(true); }
                }, 400);
            };

            const statsData = useMemo(() => {
                const langH = history.filter(h => h.languageId === selectedLangId);
                const total = langH.length, goods = langH.filter(h => h.rating === 2).length;
                const heatmap = {}; const now = new Date();
                for (let i = 0; i < 154; i++) {
                    const d = new Date(); d.setDate(now.getDate() - i);
                    heatmap[d.toISOString().split('T')[0]] = 0;
                }
                langH.forEach(h => { if(heatmap[h.date] !== undefined) heatmap[h.date]++ });
                let streak = 0; const keys = Object.keys(heatmap).sort().reverse();
                for (let k of keys) { if (heatmap[k] > 0) streak++; else if (k !== keys[0]) break; }
                return { successRate: total > 0 ? Math.round((goods / total) * 100) : 0, heatmap, streak };
            }, [history, selectedLangId]);

            const exportAll = () => {
                const dataStr = JSON.stringify({ languages, categories, cards, history });
                const currentHtml = document.documentElement.outerHTML;
                const search = 'window.__SPARK_DATA__ = null;';
                const replace = `window.__SPARK_DATA__ = ${dataStr};`;
                const blob = new Blob([currentHtml.replace(search, replace)], { type: 'text/html' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `SparkVocab_Library.html`; a.click();
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col shadow-2xl relative overflow-hidden">
                    <input type="file" ref={fileInputRef} onChange={(e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const content = ev.target.result;
                            const marker = 'window.__SPARK_DATA__ = ';
                            const start = content.indexOf(marker);
                            if (start !== -1) {
                                try {
                                    const jsonStr = content.substring(start + marker.length).split(';')[0];
                                    const data = JSON.parse(jsonStr);
                                    if (confirm("Daten importieren? Aktuelle Daten werden überschrieben.")) {
                                        setLanguages(data.languages || []);
                                        setCategories(data.categories || []);
                                        setCards(data.cards || []);
                                        setHistory(data.history || []);
                                        setShowSettings(false);
                                    }
                                } catch(err) { alert("Formatfehler."); }
                            }
                        };
                        reader.readAsText(file);
                    }} accept=".html" className="hidden" />

                    {/* HEADER */}
                    <header className="p-4 border-b bg-white flex items-center justify-between sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-3">
                            {view !== 'LANGUAGES' && (
                                <button onClick={() => { 
                                    if (view === 'DETAIL') setView('HOME'); 
                                    else { setView('LANGUAGES'); setSelectedLangId(null); }
                                    setShowStats(false);
                                }} className="p-2 -ml-2 text-slate-400 hover:bg-slate-50 rounded-full transition-colors"><Icons.ArrowLeft /></button>
                            )}
                            <h1 className="font-extrabold text-xl text-slate-800 tracking-tight">
                                {view === 'LANGUAGES' ? 'Meine Sprachen' : (activeLang?.name || 'Vorschau')}
                            </h1>
                        </div>
                        <div className="flex gap-1">
                            {selectedLangId && <button onClick={() => setShowStats(!showStats)} className={`p-2 rounded-lg ${showStats ? 'text-indigo-600 bg-indigo-50' : 'text-slate-300'}`}><Icons.BarChart /></button>}
                            {view === 'LANGUAGES' && <button onClick={() => setShowSettings(true)} className="p-2 text-slate-300"><Icons.Settings /></button>}
                        </div>
                    </header>

                    <main className="flex-1 p-5 overflow-y-auto">
                        
                        {/* 1. SPRACHAUSWAHL */}
                        {view === 'LANGUAGES' && (
                            <div className="space-y-4 animate-in fade-in">
                                <button onClick={() => { setModalInput(''); setShowNewModal({type: 'lang', id: null}); }} className="w-full p-4 bg-indigo-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg"><Icons.Plus /> Sprache hinzufügen</button>
                                <div className="grid gap-3">
                                    {languages.map(lang => (
                                        <div key={lang.id} className="group relative bg-white border border-slate-200 rounded-2xl shadow-sm hover:border-indigo-200 active:bg-slate-50 transition-all">
                                            <div onClick={() => { setSelectedLangId(lang.id); setView('HOME'); }} className="p-5 flex items-center justify-between cursor-pointer">
                                                <div className="flex items-center gap-4">
                                                    <div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><Icons.Globe /></div>
                                                    <div className="font-bold text-slate-800">{lang.name}</div>
                                                </div>
                                                <div className="text-[10px] font-black text-slate-300 uppercase tracking-widest">{cards.filter(c => c.languageId === lang.id).length} Karten</div>
                                            </div>
                                            <div className="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => { setModalInput(lang.name); setShowNewModal({type: 'lang', id: lang.id}); }} className="p-2 text-indigo-400 hover:bg-indigo-50 rounded-lg"><Icons.Edit /></button>
                                                <button onClick={() => { if(confirm("Sprache löschen?")) { setLanguages(ls=>ls.filter(l=>l.id!==lang.id)); setCategories(cs=>cs.filter(c=>c.languageId!==lang.id)); setCards(cs=>cs.filter(c=>c.languageId!==lang.id)); }}} className="p-2 text-rose-300 hover:text-rose-500 rounded-lg"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* STATS VIEW */}
                        {showStats && (
                            <div className="space-y-6 animate-in fade-in mb-8">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white p-4 rounded-3xl border shadow-sm flex flex-col items-center">
                                        <div className="text-emerald-500 mb-1 font-bold text-[10px] uppercase tracking-widest">Erfolg</div>
                                        <div className="text-2xl font-black">{statsData.successRate}%</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-3xl border shadow-sm flex flex-col items-center">
                                        <div className="text-orange-500 mb-1 font-bold text-[10px] uppercase tracking-widest">Streak</div>
                                        <div className="text-2xl font-black">{statsData.streak} Tage</div>
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-3xl border shadow-sm"><h3 className="text-[9px] font-black uppercase text-slate-400 mb-4 text-center">Aktivität ({activeLang?.name})</h3><div className="heatmap-grid">{Object.keys(statsData.heatmap).sort().map(d => {const c = statsData.heatmap[d]; let cl = 'bg-slate-100'; if (c > 0) cl = 'bg-emerald-200'; if (c > 5) cl = 'bg-emerald-400'; if (c > 15) cl = 'bg-emerald-600'; if (c > 30) cl = 'bg-emerald-800'; return <div key={d} className={`heatmap-cell ${cl}`} />})}</div></div>
                            </div>
                        )}

                        {/* 2. ORDNERÜBERSICHT */}
                        {view === 'HOME' && !showStats && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowRandomChoice(true)} className="bg-indigo-600 text-white p-4 rounded-3xl shadow-lg flex flex-col items-center justify-center gap-2 active:scale-95 transition-all"><Icons.Shuffle /><span className="text-[10px] font-black uppercase">Zufall (VOK)</span></button>
                                    <button onClick={() => {
                                        const v = cards.filter(c => c.languageId === selectedLangId && c.type === 'verb');
                                        if (v.length === 0) return alert("Keine Verben vorhanden.");
                                        setStudySession({ queue: v.map(c=>({...c, displayFront: c.front, displayBack: c.back})).sort(()=>Math.random()-0.5), index: 0, flipped: false, title: "Verben Training", isRandom: true, isChanging: false });
                                    }} className="bg-emerald-600 text-white p-4 rounded-3xl shadow-lg flex flex-col items-center justify-center gap-2 active:scale-95 transition-all text-center leading-tight"><Icons.Activity /><span className="text-[10px] font-black uppercase text-center leading-none">Verben Training</span></button>
                                </div>
                                <div className="flex justify-between items-center px-1 pt-4 border-t mt-2"><h2 className="text-xs font-black uppercase text-slate-400 tracking-widest leading-none">Ordner</h2><button onClick={() => { setModalInput(''); setShowNewModal({type: 'cat', id: null}); }} className="text-indigo-600 font-bold flex items-center gap-1 text-xs"><Icons.Plus /> Neu</button></div>
                                <div className="grid gap-3">
                                    {langCategories.map(cat => {
                                        const due = cards.filter(c => c.categoryId === cat.id && c.srs.nextReview <= Date.now()).length;
                                        return (
                                            <div key={cat.id} className="group relative bg-white border border-slate-200 rounded-2xl shadow-sm transition-all active:bg-slate-100 overflow-hidden">
                                                <div onClick={() => { setSelectedCatId(cat.id); setView('DETAIL'); }} className="p-5 flex items-center justify-between cursor-pointer">
                                                    <div className="flex items-center gap-4"><div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><Icons.Folder /></div><div className="font-bold text-slate-800 truncate max-w-[140px]">{cat.name}</div></div>
                                                    {due > 0 && <span className="bg-orange-500 text-white text-[10px] px-2 py-1 rounded-full font-black">{due}</span>}
                                                </div>
                                                <div className="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => { setModalInput(cat.name); setShowNewModal({type: 'cat', id: cat.id}); }} className="p-2 text-indigo-400 hover:bg-indigo-50 rounded-lg"><Icons.Edit /></button><button onClick={() => { if(confirm("Ordner löschen?")) { setCategories(p => p.filter(c => c.id !== cat.id)); setCards(p => p.filter(c => c.categoryId !== cat.id)); } }} className="p-2 text-rose-300 hover:text-rose-500 rounded-lg"><Icons.Trash /></button></div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 3. ORDNERDETAIL */}
                        {view === 'DETAIL' && activeCategory && (
                            <div className="space-y-6 pb-20 animate-in slide-in-from-right-4">
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => {
                                        const due = folderCards.filter(c => c.srs.nextReview <= Date.now());
                                        if (due.length === 0) return alert("Alles aktuell!");
                                        setStudySession({ queue: due.sort(()=>Math.random()-0.5), index: 0, flipped: false, title: activeCategory.name, isRandom: false, isChanging: false });
                                    }} className={`py-4 rounded-3xl font-black text-xs shadow-lg flex items-center justify-center gap-2 ${folderCards.filter(c => c.srs.nextReview <= Date.now()).length > 0 ? 'bg-indigo-600 text-white shadow-indigo-100' : 'bg-slate-200 text-slate-400'}`}><Icons.Book /> {folderCards.filter(c => c.srs.nextReview <= Date.now()).length} fällig</button>
                                    <button onClick={() => {
                                        const std = folderCards.filter(c => c.type === 'standard');
                                        if (std.length === 0) return alert("Keine Vokabeln.");
                                        setStudySession({ queue: std.map(c => { const f=Math.random()>0.5; return {...c, displayFront: f?c.back:c.front, displayBack: f?c.front:c.back}}).sort(()=>Math.random()-0.5), index: 0, flipped: false, title: `Zufall`, isRandom: true, isChanging: false });
                                    }} className="bg-slate-800 text-white py-4 rounded-3xl font-black text-xs shadow-lg flex items-center justify-center gap-2 active:scale-95"><Icons.Shuffle /> Zufall</button>
                                </div>
                                <form onSubmit={saveCard} className="bg-white border-2 border-indigo-100 p-5 rounded-3xl space-y-4 shadow-sm">
                                    <div className="flex bg-slate-100 p-1 rounded-xl"><button type="button" onClick={() => setCardInput({...cardInput, type: 'standard'})} className={`flex-1 py-2 text-[10px] font-black rounded-lg ${cardInput.type === 'standard' ? 'bg-white shadow-sm' : 'text-slate-400'}`}>VOKABEL</button><button type="button" onClick={() => setCardInput({...cardInput, type: 'verb'})} className={`flex-1 py-2 text-[10px] font-black rounded-lg ${cardInput.type === 'verb' ? 'bg-white shadow-sm' : 'text-slate-400'}`}>VERB (RO)</button></div>
                                    <input className="w-full p-4 rounded-2xl bg-slate-50 outline-none border focus:border-indigo-500 font-bold" placeholder={cardInput.type === 'verb' ? "Infinitiv" : "Frage"} value={cardInput.front} onChange={e => setCardInput({...cardInput, front: e.target.value})} />
                                    <input className="w-full p-4 rounded-2xl bg-slate-50 outline-none border focus:border-indigo-500 font-bold" placeholder="Antwort" value={cardInput.back} onChange={e => setCardInput({...cardInput, back: e.target.value})} />
                                    {cardInput.type === 'verb' && (
                                        <div className="grid grid-cols-2 gap-2 animate-in fade-in">{['eu', 'tu', 'elEa', 'noi', 'voi', 'eiEle'].map(p => (<input key={p} className="p-3 text-xs rounded-xl bg-slate-50 outline-none border focus:border-indigo-500 font-bold" placeholder={p==='elEa'?'el/ea':p==='eiEle'?'ei/ele':p} value={cardInput.verbForms[p]} onChange={e => setCardInput({...cardInput, verbForms: {...cardInput.verbForms, [p]: e.target.value}})} />))}</div>
                                    )}
                                    <div className="flex gap-2"><button type="submit" className="flex-[3] bg-slate-800 text-white py-4 rounded-2xl font-bold">{cardInput.id ? 'Update' : 'Hinzufügen'}</button>{cardInput.id && <button type="button" onClick={() => setCardInput({ id: null, front: '', back: '', type: 'standard', verbForms: { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } })} className="flex-1 bg-slate-200 text-slate-500 py-4 rounded-2xl font-bold">X</button>}</div>
                                </form>
                                <div className="space-y-2">
                                    {folderCards.map(card => (
                                        <div key={card.id} className="p-4 bg-white border rounded-2xl flex justify-between items-center group shadow-sm hover:border-indigo-200">
                                            <div className="truncate pr-4 leading-tight"><div className="font-bold text-slate-800 truncate">{card.front} {card.type==='verb' && <span className="text-[7px] bg-emerald-100 text-emerald-600 px-1 rounded font-black uppercase ml-1 tracking-widest">Verb</span>}</div><div className="text-xs text-slate-400 truncate mt-1">{card.back}</div><div className="flex gap-2 mt-2"><span className="text-[8px] font-black uppercase text-indigo-400 bg-indigo-50 px-1.5 py-0.5 rounded-full">Box {card.srs.repetitions}</span><span className="text-[8px] font-black uppercase text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded-full">Versuche: {card.totalAttempts}</span></div></div>
                                            <div className="flex items-center gap-1 opacity-20 group-hover:opacity-100 transition-opacity"><button onClick={() => setAnalysisCard(card)} className="text-slate-400 p-2"><Icons.Info /></button><button onClick={() => { setCardInput({ ...card, verbForms: card.verbForms || { eu: '', tu: '', elEa: '', noi: '', voi: '', eiEle: '' } }); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="text-indigo-500 p-2"><Icons.Edit /></button><button onClick={() => setCards(p => p.filter(c => c.id !== card.id))} className="text-rose-500 p-2"><Icons.Trash /></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* STUDY UI */}
                        {studySession && (
                            <div className="fixed inset-0 bg-slate-50 z-[100] flex flex-col p-6 animate-in fade-in no-select">
                                <div className="flex justify-between items-center mb-6"><button onClick={() => setStudySession(null)} className="text-slate-400 font-bold text-sm">Beenden</button><div className="text-center font-bold text-xs"><div className="text-[9px] font-black uppercase text-slate-400 tracking-widest leading-none">{studySession.title}</div>{studySession.index + 1} / {studySession.queue.length}</div><div className="w-10"></div></div>
                                <div className="flex-1 flex items-center justify-center perspective-1000">
                                    <div className={`relative w-full aspect-[4/5] max-h-[520px] card-inner preserve-3d cursor-pointer ${studySession.flipped ? 'rotate-y-180' : ''}`} onClick={() => !studySession.isChanging && setStudySession({...studySession, flipped: !studySession.flipped})}>
                                        <div className="absolute inset-0 backface-hidden bg-white rounded-[2.5rem] shadow-2xl border flex flex-col items-center justify-center p-10 text-center"><div className="text-3xl font-black text-slate-800 leading-tight">{studySession.isRandom ? studySession.queue[studySession.index].displayFront : studySession.queue[studySession.index].front}</div><div className="absolute bottom-10 text-indigo-300 uppercase tracking-widest text-[9px] font-black animate-pulse">Tippen zum Umdrehen</div></div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-indigo-600 rounded-[2.5rem] shadow-2xl flex flex-col items-center justify-center p-6 text-center text-white overflow-hidden">
                                            {studySession.flipped && (
                                                <div className="w-full relative h-full flex flex-col justify-center">
                                                    {studySession.queue[studySession.index].type !== 'verb' && (<div className="absolute top-0 right-0 bg-white/20 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest">{studySession.queue[studySession.index].totalAttempts + 1}. Versuch</div>)}
                                                    {studySession.queue[studySession.index].type === 'verb' ? (<div className="space-y-4 w-full"><div className="mb-2"><div className="text-2xl font-black mb-1">{studySession.queue[studySession.index].back}</div><div className="text-indigo-200 text-xs font-bold uppercase tracking-widest">{studySession.queue[studySession.index].front}</div></div><div className="bg-indigo-500/40 p-4 rounded-3xl border border-indigo-400/30 space-y-1">{[{l:'eu',k:'eu'},{l:'tu',k:'tu'},{l:'el/ea',k:'elEa'},{l:'noi',k:'noi'},{l:'voi',k:'voi'},{l:'ei/ele',k:'eiEle'}].map((item, idx) => (<div key={idx} onClick={(e) => { e.stopPropagation(); setRevealedForms(p => ({ ...p, [idx]: !p[idx] })); }} className={`flex justify-between items-center py-1.5 px-3 rounded-xl transition-colors cursor-pointer ${revealedForms[idx] ? 'bg-indigo-400/20' : 'hover:bg-white/5'}`}><span className="text-[10px] text-indigo-200 uppercase font-black tracking-wider">{item.l}</span><div className="flex items-center gap-2"><span className={`font-bold transition-all duration-300 ${revealedForms[idx] ? 'opacity-100' : 'opacity-0 hidden-verb text-transparent select-none'}`}>{studySession.queue[studySession.index].verbForms[item.k]}</span>{!revealedForms[idx] && <Icons.Eye />}</div></div>))}</div></div>) : (<div className="text-3xl font-black leading-tight">{studySession.isRandom ? studySession.queue[studySession.index].displayBack : studySession.queue[studySession.index].back}</div>)}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className={`mt-10 grid gap-3 transition-all duration-300 ${studySession.flipped && !studySession.isChanging ? 'opacity-100' : 'opacity-0 translate-y-10 pointer-events-none'}`}>{studySession.isRandom ? (<button onClick={() => handleRate(1)} className="bg-slate-800 text-white py-5 rounded-3xl font-black text-lg shadow-xl active:scale-95 transition-transform">Nächste Karte</button>) : (<div className="grid grid-cols-3 gap-3"><button onClick={() => handleRate(0)} className="bg-rose-500 text-white py-5 rounded-3xl flex flex-col items-center gap-1 active:scale-90 shadow-lg transition-transform"><Icons.Shuffle /><span className="text-[10px] font-black uppercase text-center">Nicht</span></button><button onClick={() => handleRate(1)} className="bg-amber-500 text-white py-5 rounded-3xl flex flex-col items-center gap-1 active:scale-90 shadow-lg transition-transform"><Icons.Book /><span className="text-[10px] font-black uppercase text-center">Mittel</span></button><button onClick={() => handleRate(2)} className="bg-emerald-500 text-white py-5 rounded-3xl flex flex-col items-center gap-1 active:scale-90 shadow-lg transition-transform"><Icons.Plus /><span className="text-[10px] font-black uppercase text-center">Gut</span></button></div>)}</div>
                            </div>
                        )}

                        {/* MODALS */}
                        {showNewModal.type && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-center justify-center p-6" onClick={() => setShowNewModal({type: null, id: null})}><div className="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl space-y-6 animate-in zoom-in-95" onClick={e => e.stopPropagation()}><h2 className="text-xl font-black text-slate-800">{showNewModal.id ? 'Bearbeiten' : 'Neu erstellen'}</h2><input autoFocus className="w-full p-4 rounded-2xl bg-slate-100 outline-none focus:ring-2 focus:ring-indigo-500 font-bold" placeholder="Name..." value={modalInput} onChange={e => setModalInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && (showNewModal.type === 'lang' ? saveLanguage() : saveCategory())} /><div className="flex gap-3"><button onClick={showNewModal.type === 'lang' ? saveLanguage : saveCategory} className="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg transition-all uppercase text-xs">OK</button><button onClick={() => setShowNewModal({type: null, id: null})} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold uppercase text-xs">X</button></div></div></div>
                        )}

                        {showSettings && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-center justify-center p-6" onClick={() => setShowSettings(false)}><div className="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl space-y-6" onClick={e => e.stopPropagation()}><h2 className="text-xl font-black text-slate-800">Sicherung</h2><div className="space-y-4"><button onClick={exportAll} className="w-full flex items-center justify-between p-5 bg-indigo-50 text-indigo-700 rounded-2xl font-bold active:scale-95 transition-all">HTML exportieren <Icons.Download /></button><button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-between p-5 bg-emerald-50 text-emerald-700 rounded-2xl font-bold active:scale-95 transition-all">Importieren <Icons.Plus /></button></div><button onClick={() => setShowSettings(false)} className="w-full text-slate-400 py-2 text-sm font-bold uppercase tracking-widest text-center">Schließen</button></div></div>
                        )}

                        {showRandomChoice && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-end sm:items-center justify-center p-4" onClick={() => setShowRandomChoice(false)}><div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl space-y-4 animate-in slide-in-from-bottom-10" onClick={e => e.stopPropagation()}><h2 className="text-lg font-black text-slate-800 text-center">Zufall</h2><button onClick={() => {const vO=cards.filter(c=>c.languageId===selectedLangId && c.type==='standard'); if(vO.length===0) return alert("Keine Vokabeln."); setStudySession({queue:vO.map(c=>{const f=Math.random()>0.5;return{...c,displayFront:f?c.back:c.front,displayBack:f?c.front:c.back}}).sort(()=>Math.random()-0.5),index:0,flipped:false,title:'Alles',isRandom:true,isChanging:false}); setShowRandomChoice(false); }} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-lg">Alles mischen</button><div className="max-h-60 overflow-y-auto space-y-2 pr-1"><p className="text-[9px] font-black uppercase text-slate-400 tracking-widest px-1">Ordner</p>{langCategories.map(cat => (<button key={cat.id} onClick={() => {const fl=cards.filter(c=>c.categoryId===cat.id && c.type==='standard'); if(fl.length===0) return alert("Leer."); setStudySession({queue:fl.map(c=>{const f=Math.random()>0.5;return{...c,displayFront:f?c.back:c.front,displayBack:f?c.front:c.back}}).sort(()=>Math.random()-0.5),index:0,flipped:false,title:cat.name,isRandom:true,isChanging:false}); setShowRandomChoice(false); }} className="w-full bg-slate-100 text-slate-700 py-3 px-4 rounded-xl text-left font-bold text-sm truncate">{cat.name}</button>))}</div><button onClick={() => setShowRandomChoice(false)} className="w-full text-slate-400 py-2 text-sm font-bold uppercase text-center">Abbrechen</button></div></div>
                        )}

                        {analysisCard && (
                            <div className="fixed inset-0 bg-slate-900/60 z-[200] flex items-center justify-center p-6" onClick={() => setAnalysisCard(null)}><div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl space-y-6 animate-in zoom-in-95" onClick={e => e.stopPropagation()}><h2 className="text-xl font-black text-slate-800">Analyse</h2><div className="p-4 bg-indigo-50 rounded-2xl space-y-3"><div className="flex justify-between items-center"><span className="text-xs text-slate-500 font-bold uppercase tracking-widest">Box</span><span className="font-black text-indigo-700">{analysisCard.srs.repetitions}</span></div><div className="flex justify-between items-center"><span className="text-xs text-slate-500 font-bold uppercase tracking-widest">Ease</span><span className="font-black text-indigo-700">{analysisCard.srs.ease.toFixed(2)}x</span></div><div className="flex justify-between items-center"><span className="text-xs text-slate-500 font-bold uppercase tracking-widest">Versuche</span><span className="font-black text-indigo-700">{analysisCard.totalAttempts}</span></div></div><button onClick={() => setAnalysisCard(null)} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold uppercase text-center text-xs">OK</button></div></div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

